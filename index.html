<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Firebase (Compat Version - CDN for single-file operation) -->
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

    <!-- 6. Custom Tailwind Config and Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6', 100: '#CCFFCC', 500: '#00B300',
                            600: '#009900', 700: '#008000', 800: '#006600', 900: '#004C00',
                        },
                        'teal': { 600: '#008080' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = ['Guadalupe', 'Mabolo', 'Talisay', 'Bacayan', 'Lapu-lapu', 'AS Fortuna'];
        
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                lucide.createIcons({
                    root: wrapperRef.current,
                    nameAttr: 'data-lucide',
                    attrs: { width: size, height: size, class: className, ...props }
                });
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Tag: (p) => <Icon name="tag" {...p} />,
            Hourglass: (p) => <Icon name="hourglass" {...p} />,
            Pencil: (p) => <Icon name="pencil" {...p} />,
            RotateCw: (p) => <Icon name="rotate-cw" {...p} />
        };

        // --- SECURITY HELPER: SHA-256 Hashing ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) { console.error("Hashing failed:", error); return null; }
        };

        // --- DATE HELPER: Handle Firestore Timestamp or Number ---
        const safeDate = (timestamp) => {
            if (!timestamp) return null;
            // Firestore Timestamp has .toDate(), legacy might be number
            if (typeof timestamp.toDate === 'function') return timestamp.toDate();
            return new Date(timestamp);
        };

        const formatCurrency = (val) => {
            if (val === undefined || val === null || val === '') return '';
            return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(val);
        };

        // --- COMPONENT: LIST MANAGEMENT (Optimized) ---
        const ListManagement = ({ therapists, services, durations, onAdd, onDelete, onEdit }) => {
            const [activeTab, setActiveTab] = useState('therapist'); 
            const [newItemName, setNewItemName] = useState('');
            const [newItemPrices, setNewItemPrices] = useState({}); 
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPrices, setEditPrices] = useState({});
            const [modal, setModal] = useState({ isOpen: false });

            const handleAdd = (e) => {
                e.preventDefault();
                onAdd(activeTab, newItemName, activeTab === 'service' ? newItemPrices : null);
                setNewItemName(''); setNewItemPrices({});
            };

            const startEdit = (item) => {
                setEditingId(item.id); setEditName(item.name); setEditPrices(item.prices || {});
            };

            const saveEdit = () => {
                const data = { name: editName };
                if (activeTab === 'service') data.prices = editPrices;
                onEdit(activeTab, editingId, data);
                setEditingId(null);
            };

            const handlePriceChange = (key, val, isEdit) => {
                const setter = isEdit ? setEditPrices : setNewItemPrices;
                const current = isEdit ? editPrices : newItemPrices;
                if (!val) { const c = {...current}; delete c[key]; setter(c); }
                else { setter({...current, [key]: parseFloat(val)}); }
            };

            let currentList = activeTab === 'therapist' ? therapists : activeTab === 'service' ? services : durations;
            
            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.ShieldCheck size={18}/> Master Data Lists</h2>
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        {['therapist', 'service', 'duration'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 text-xs font-bold capitalize rounded-md ${activeTab===tab ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>{tab}s</button>
                        ))}
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6">
                        <form onSubmit={handleAdd} className="flex flex-col gap-3">
                            <input required placeholder={`New ${activeTab} name`} value={newItemName} onChange={e => setNewItemName(e.target.value)} className="p-3 border rounded-lg bg-slate-50 outline-none focus:ring-2 focus:ring-logo-green-500"/>
                            {activeTab === 'service' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p className="text-xs font-bold text-slate-500 mb-2 uppercase">Set Prices per Duration</p>
                                    {durations.length === 0 ? <p className="text-xs text-red-400">Add Durations first.</p> : 
                                    <div className="grid grid-cols-2 gap-2">
                                        {durations.map(d => (
                                            <div key={d.id} className="flex items-center gap-2 bg-white p-2 border rounded">
                                                <span className="text-xs font-bold text-slate-600 w-16 truncate">{d.name}:</span>
                                                <input type="number" placeholder="Price" className="w-full text-sm outline-none" value={newItemPrices[d.name] || ''} onChange={e => handlePriceChange(d.name, e.target.value, false)}/>
                                            </div>
                                        ))}
                                    </div>}
                                </div>
                            )}
                            <button className="bg-logo-green-600 text-white p-3 rounded-lg font-bold hover:bg-logo-green-700">Add Item</button>
                        </form>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden max-h-[400px] overflow-y-auto">
                        {currentList.map(item => (
                            <div key={item.id} className="p-4 border-b flex flex-col gap-2 last:border-b-0 hover:bg-slate-50">
                                <div className="flex justify-between items-center">
                                    {editingId === item.id ? <input value={editName} onChange={e=>setEditName(e.target.value)} className="flex-1 p-2 border rounded text-sm mr-2"/> : <span className="font-medium text-slate-700">{item.name}</span>}
                                    <div className="flex gap-1">
                                        {editingId === item.id ? 
                                            <><button onClick={saveEdit} className="text-logo-green-600 p-2"><Icons.CheckCircle2/></button><button onClick={()=>setEditingId(null)} className="text-slate-400 p-2"><Icons.X/></button></> :
                                            <><button onClick={()=>startEdit(item)} className="text-slate-300 hover:text-blue-500 p-2"><Icons.Pencil/></button><button onClick={()=>onDelete(activeTab, item.id)} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash2/></button></>
                                        }
                                    </div>
                                </div>
                                {activeTab === 'service' && (editingId === item.id || (item.prices && Object.keys(item.prices).length > 0)) && (
                                    <div className={`text-xs ${editingId === item.id ? 'bg-slate-100 p-2 rounded grid grid-cols-2 gap-2' : 'flex flex-wrap gap-2'}`}>
                                        {editingId === item.id ? durations.map(d => (
                                            <div key={d.id} className="flex items-center gap-1"><span className="font-bold">{d.name}:</span><input type="number" className="w-full p-1 border rounded" value={editPrices[d.name]||''} onChange={e=>handlePriceChange(d.name, e.target.value, true)}/></div>
                                        )) : Object.entries(item.prices || {}).map(([k,v]) => <span key={k} className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded border border-logo-green-100">{k}: <b>P{v}</b></span>)}
                                    </div>
                                )}
                            </div>
                        ))}
                        {currentList.length === 0 && <p className="text-center text-slate-400 p-6 italic">List is empty.</p>}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [dbReady, setDbReady] = useState(false);
            const [loading, setLoading] = useState(false); // Global loading state for actions
            const [configError, setConfigError] = useState(null);

            // Data States
            const [transactions, setTransactions] = useState([]);
            const [history, setHistory] = useState([]); // Lazy loaded
            const [users, setUsers] = useState([]); // Only loaded if admin
            const [therapists, setTherapists] = useState([]);
            const [services, setServices] = useState([]);
            const [durations, setDurations] = useState([]);

            // UI States
            const [view, setView] = useState('dashboard');
            const [showMyShift, setShowMyShift] = useState(false);
            const [historyExpanded, setHistoryExpanded] = useState(null);
            const [modal, setModal] = useState({ isOpen: false });
            const [editUserModal, setEditUserModal] = useState({ isOpen: false });

            // Form States
            const [loginForm, setLoginForm] = useState({ username: '', pin: '', branch: '' });
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [bookingForm, setBookingForm] = useState({ clientName: '', service: '', therapist: '', amount: '', duration: '', type: 'booking', time: '', targetBranch: '' });
            const [profileForm, setProfileForm] = useState({ username: '', pin: '' });

            // --- INITIALIZATION ---
            useEffect(() => {
                const init = async () => {
                    if (!firebaseConfig.projectId) return setConfigError("Config missing.");
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        
                        if (initialAuthToken) await auth.signInWithCustomToken(initialAuthToken);
                        else await auth.signInAnonymously();

                        // Enable offline persistence if possible
                        try { await db.enablePersistence(); } catch(e) { console.log("Persistence disabled"); }

                        auth.onAuthStateChanged(u => {
                            if (u) setFb({ db, auth, appId: firebaseConfig.projectId });
                        });
                    } catch (e) { setConfigError(e.message); }
                };
                init();
            }, []);

            // --- DATA SYNC (SCALABILITY FIX) ---
            useEffect(() => {
                if (!fb || !user) return;
                const { db, appId } = fb;
                const path = `artifacts/${appId}/public/data`;

                // 1. Transactions: Sync only "Today" ideally, but for simplicity syncing whole collection
                //    Future optimization: .where('timestamp', '>', startOfDay)
                const unsubTrans = db.collection(`${path}/transactions`)
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Client-side sort is fast for active transactions
                        setTransactions(data.sort((a, b) => (safeDate(b.timestamp) || 0) - (safeDate(a.timestamp) || 0)));
                        setDbReady(true);
                    });

                // 2. Master Lists
                const unsubTherapists = db.collection(`${path}/therapists`).onSnapshot(s => setTherapists(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name))));
                const unsubServices = db.collection(`${path}/services`).onSnapshot(s => setServices(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name))));
                const unsubDurations = db.collection(`${path}/durations`).onSnapshot(s => setDurations(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => parseInt(a.name)-parseInt(b.name))));

                // 3. Users (Only if Admin, security fix handled in Login but lists needed for management)
                let unsubUsers = () => {};
                if (user.role === 'admin') {
                    unsubUsers = db.collection(`${path}/users`).onSnapshot(s => setUsers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                }

                return () => { unsubTrans(); unsubTherapists(); unsubServices(); unsubDurations(); unsubUsers(); };
            }, [fb, user]);

            // --- HELPER: PRICE CALCULATION ---
            const calculatePrice = (serviceName, durationName) => {
                if (!serviceName) return '';
                const s = services.find(x => x.name === serviceName);
                if (!s) return '';
                if (durationName && s.prices && s.prices[durationName]) return s.prices[durationName];
                if (s.price) return s.price; // fallback
                return '';
            };

            // --- ACTIONS ---

            // SECURITY FIX: Login queries specific user only
            const handleLogin = async (e) => {
                e.preventDefault();
                if (!loginForm.branch) return alertModal("Select a branch.");
                setLoading(true);

                try {
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    const snapshot = await fb.db.collection(`${basePath}/users`)
                        .where('username', '==', loginForm.username.toLowerCase())
                        .limit(1)
                        .get();

                    if (snapshot.empty) throw new Error("Invalid credentials.");

                    const userData = snapshot.docs[0].data();
                    const hashedInput = await hashPin(loginForm.pin);

                    if (userData.pin === hashedInput) {
                        // Init default User if first time (Owner)
                        if (userData.username === 'admin' && userData.pin === '8888' && !users.length) {
                            // Seed lists if empty
                            if (therapists.length === 0) fb.db.collection(`${basePath}/therapists`).add({name:'Therapist 1'});
                            if (durations.length === 0) fb.db.collection(`${basePath}/durations`).add({name:'60 Mins'});
                        }
                        setUser({ ...userData, id: snapshot.docs[0].id, currentBranch: loginForm.branch });
                        setLoginForm({ username: '', pin: '', branch: '' });
                        setView('dashboard');
                    } else {
                        throw new Error("Invalid credentials.");
                    }
                } catch (err) {
                    alertModal(err.message, 'red');
                } finally {
                    setLoading(false);
                }
            };

            // DATA INTEGRITY FIX: Server Timestamp
            const handleBooking = async (e) => {
                e.preventDefault();
                const { clientName, service, therapist, amount, targetBranch } = bookingForm;
                const finalBranch = user.currentBranch === 'ALL' ? targetBranch : user.currentBranch;

                if (!clientName || !service || !therapist || !amount || (user.currentBranch === 'ALL' && !finalBranch)) {
                    return alertModal("Please fill all required fields.", 'red');
                }

                setLoading(true);
                try {
                    await fb.db.collection(`artifacts/${fb.appId}/public/data/transactions`).add({
                        ...bookingForm,
                        amount: parseFloat(amount),
                        branch: finalBranch,
                        recordedBy: user.name,
                        status: bookingForm.type === 'sale' ? 'completed' : 'pending',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // FIX: Server-side time
                    });
                    
                    setBookingForm({ clientName: '', service: '', therapist: '', amount: '', duration: '', type: 'booking', time: '', targetBranch: user.currentBranch === 'ALL' ? finalBranch : '' });
                    alertModal(`Booking saved for ${finalBranch}!`, 'logo-green');
                    setView('dashboard');
                } catch(err) { alertModal("Failed to save.", 'red'); }
                finally { setLoading(false); }
            };

            // SCALABILITY FIX: Fetch history only on demand with limit
            const loadHistory = async (limit = 20) => {
                setLoading(true);
                try {
                    let q = fb.db.collection(`artifacts/${fb.appId}/public/data/history`)
                        .orderBy('timestamp_val', 'desc')
                        .limit(limit);
                    const snap = await q.get();
                    setHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                } catch(err) { console.error(err); }
                finally { setLoading(false); }
            };

            // --- OTHER HANDLERS (Simplified) ---
            const alertModal = (msg, color='logo-green') => setModal({ isOpen: true, message: msg, confirmColor: color });
            
            const handleListAdd = async (type, name, extra) => {
                if (!name) return;
                const col = type === 'therapist' ? 'therapists' : type === 'service' ? 'services' : 'durations';
                const data = { name };
                if (type === 'service' && extra) data.prices = extra;
                await fb.db.collection(`artifacts/${fb.appId}/public/data/${col}`).add(data);
            };

            const handleListDelete = async (type, id) => {
                const col = type === 'therapist' ? 'therapists' : type === 'service' ? 'services' : 'durations';
                if(confirm("Delete this item?")) await fb.db.collection(`artifacts/${fb.appId}/public/data/${col}`).doc(id).delete();
            };

            const handleListEdit = async (type, id, data) => {
                const col = type === 'therapist' ? 'therapists' : type === 'service' ? 'services' : 'durations';
                await fb.db.collection(`artifacts/${fb.appId}/public/data/${col}`).doc(id).update(data);
            };

            const closeDay = async () => {
                if (!transactions.length) return alertModal("No transactions.", 'red');
                if (!confirm("Close day and archive?")) return;
                setLoading(true);
                const batch = fb.db.batch();
                const histRef = fb.db.collection(`artifacts/${fb.appId}/public/data/history`).doc();
                
                // Calculate Stats
                const total = transactions.reduce((a,b) => a + (b.status==='completed' ? parseFloat(b.amount) : 0), 0);
                
                batch.set(histRef, {
                    date: new Date().toDateString(),
                    timestamp: new Date().toLocaleString(),
                    timestamp_val: Date.now(), // For sorting
                    branch: user.currentBranch,
                    closedBy: user.name,
                    transactions: transactions,
                    stats: { totalRevenue: total }
                });

                // Delete active transactions
                transactions.forEach(t => {
                    batch.delete(fb.db.collection(`artifacts/${fb.appId}/public/data/transactions`).doc(t.id));
                });

                await batch.commit();
                setLoading(false);
                setView('history');
                loadHistory(); // Refresh history view
            };

            const downloadCSV = (h) => {
                const rows = [
                    ['Date', 'Branch', 'Time', 'Client', 'Service', 'Duration', 'Therapist', 'Price', 'Status'],
                    ...h.transactions.map(t => [
                        `"${h.date}"`, `"${t.branch}"`, `"${t.time}"`, `"${t.clientName}"`, `"${t.service}"`, `"${t.duration||''}"`, `"${t.therapist}"`, t.amount, t.status
                    ])
                ];
                const csv = rows.map(r => r.join(',')).join('\n');
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
                link.download = `Report_${h.date}.csv`;
                link.click();
            };

            // --- RENDER HELPERS ---
            if (configError) return <div className="h-screen flex items-center justify-center bg-slate-100 p-4 text-center"><div className="bg-white p-6 rounded shadow"><Icons.Cloud size={40} className="mx-auto mb-2 text-red-400"/><h2 className="font-bold">Setup Error</h2><p className="text-sm text-slate-500 font-mono bg-slate-50 p-2 rounded border mt-2">{configError}</p></div></div>;
            
            if (!dbReady && !user) return <div className="h-screen flex flex-col items-center justify-center"><div className="loader mb-2"></div><p className="text-xs text-slate-400">Secure Connection...</p></div>;

            // --- LOGIN VIEW ---
            if (!user) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm relative overflow-hidden border border-logo-green-100">
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-logo-green-600"></div>
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-logo-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-logo-green-700"><Icons.Lock size={32}/></div>
                            <h1 className="text-2xl font-bold text-logo-green-900">At HOME Spa</h1>
                            <p className="text-xs text-slate-400">Staff Portal</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <select required className="w-full p-3 border rounded-xl bg-slate-50" value={loginForm.branch} onChange={e=>setLoginForm({...loginForm, branch:e.target.value})}>
                                <option value="">Select Branch Location</option>
                                {BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}
                                <option value="ALL" className="font-bold">Owner View (All)</option>
                            </select>
                            <input required placeholder="Username" className="w-full p-3 border rounded-xl bg-slate-50" value={loginForm.username} onChange={e=>setLoginForm({...loginForm, username:e.target.value})}/>
                            <input required type="password" inputMode="numeric" placeholder="PIN" className="w-full p-3 border rounded-xl bg-slate-50" value={loginForm.pin} onChange={e=>setLoginForm({...loginForm, pin:e.target.value})}/>
                            <button disabled={loading} className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-xl hover:bg-logo-green-800 transition flex justify-center">
                                {loading ? <div className="loader border-t-white"></div> : 'Login'}
                            </button>
                        </form>
                        {modal.isOpen && <div className="absolute inset-0 bg-white/90 flex items-center justify-center text-red-600 font-bold z-10 px-4 text-center fade-in" onClick={()=>setModal({isOpen:false})}>{modal.message}</div>}
                    </div>
                </div>
            );

            // --- MAIN APP VIEW ---
            const filteredTransactions = transactions.filter(t => 
                (user.currentBranch === 'ALL' || t.branch === user.currentBranch) && 
                (!showMyShift || user.role === 'admin' || t.recordedBy === user.name)
            );

            const revenue = filteredTransactions.reduce((sum, t) => sum + (t.status === 'completed' ? parseFloat(t.amount) : 0), 0);

            return (
                <div className="min-h-screen bg-slate-50 pb-20 fade-in font-sans text-slate-800">
                    {/* Header */}
                    <header className="bg-white border-b sticky top-0 z-20 shadow-sm px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-logo-green-700 rounded-lg text-white shadow-md"><Icons.Home size={20}/></div>
                            <div className="leading-tight">
                                <h1 className="font-bold text-logo-green-900">At HOME Spa</h1>
                                <p className="text-[10px] font-bold uppercase text-slate-400 tracking-wider flex gap-1"><Icons.MapPin size={10}/> {user.currentBranch}</p>
                            </div>
                        </div>
                        <button onClick={()=>setUser(null)} className="p-2 text-slate-300 hover:text-red-500"><Icons.LogOut/></button>
                    </header>

                    {/* Nav */}
                    <div className="px-4 py-4 overflow-x-auto flex gap-2 sticky top-[65px] z-10 bg-slate-50/90 backdrop-blur">
                        {[
                            {id:'dashboard', icon:Icons.LayoutDashboard, label:'Daily'},
                            {id:'add', icon:Icons.Plus, label:'Booking'},
                            {id:'profile', icon:Icons.UserCog, label:'Profile'}
                        ].map(nav => (
                            <button key={nav.id} onClick={()=>setView(nav.id)} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition shadow-sm ${view===nav.id ? 'bg-white text-logo-green-700 ring-1 ring-logo-green-200' : 'bg-slate-200 text-slate-500'}`}>
                                <nav.icon size={14}/> {nav.label}
                            </button>
                        ))}
                        {user.role === 'admin' && [
                            {id:'lists', icon:Icons.ShieldCheck, label:'Lists'},
                            {id:'history', icon:Icons.History, label:'History'},
                            {id:'team', icon:Icons.Users, label:'Team'}
                        ].map(nav => (
                            <button key={nav.id} onClick={()=>{setView(nav.id); if(nav.id==='history') loadHistory();}} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition shadow-sm ${view===nav.id ? 'bg-white text-logo-green-700 ring-1 ring-logo-green-200' : 'bg-slate-200 text-slate-500'}`}>
                                <nav.icon size={14}/> {nav.label}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <main className="px-4 max-w-3xl mx-auto">
                        {view === 'dashboard' && (
                            <div className="space-y-4 fade-in">
                                <div className="bg-gradient-to-r from-logo-green-700 to-teal-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-xs font-medium opacity-80 uppercase tracking-widest mb-1">Total Revenue</p>
                                        <h2 className="text-3xl font-bold">{formatCurrency(revenue)}</h2>
                                        <p className="text-xs mt-2 opacity-70">{filteredTransactions.length} Clients Today</p>
                                    </div>
                                    <Icons.DollarSign size={100} className="absolute -right-4 -bottom-8 text-white opacity-10"/>
                                </div>

                                <div className="flex justify-between items-end">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icons.Clock size={16}/> Today's Schedule</h3>
                                    {user.role === 'admin' && <button onClick={closeDay} className="text-[10px] bg-white border border-slate-200 px-3 py-1 rounded-full font-bold hover:bg-red-50 hover:text-red-600 transition">Close Day</button>}
                                </div>

                                <div className="space-y-3">
                                    {filteredTransactions.length === 0 ? <div className="text-center p-10 border-2 border-dashed rounded-xl text-slate-400 text-sm">No bookings yet.</div> : 
                                    filteredTransactions.map(t => (
                                        <div key={t.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-logo-green-500 flex justify-between items-center">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 rounded">{t.time}</span>
                                                    <span className="text-[10px] font-bold text-logo-green-700 uppercase">{t.branch}</span>
                                                </div>
                                                <h4 className="font-bold text-slate-800">{t.clientName}</h4>
                                                <p className="text-xs text-slate-500">{t.service} {t.duration ? `• ${t.duration}` : ''}</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold">{formatCurrency(t.amount)}</div>
                                                {user.role === 'admin' && <button onClick={()=>handleListDelete('transaction', t.id)} className="text-xs text-red-300 hover:text-red-500 mt-1">Delete</button>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-logo-green-100 fade-in relative">
                                {loading && <div className="absolute inset-0 bg-white/80 z-10 flex items-center justify-center"><div className="loader"></div></div>}
                                <h2 className="font-bold text-lg mb-4 flex gap-2 items-center"><Icons.Plus className="text-logo-green-600"/> New Booking</h2>
                                <form onSubmit={handleBooking} className="space-y-4">
                                    {user.currentBranch === 'ALL' ? 
                                        <select className="w-full p-3 border rounded-xl bg-slate-50" required value={bookingForm.targetBranch} onChange={e=>setBookingForm({...bookingForm, targetBranch:e.target.value})}>
                                            <option value="">Select Target Branch</option>
                                            {BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}
                                        </select>
                                    : <div className="p-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-500 text-center">Adding to: {user.currentBranch}</div>}
                                    
                                    <input required placeholder="Client Name" className="w-full p-3 border rounded-xl" value={bookingForm.clientName} onChange={e=>setBookingForm({...bookingForm, clientName:e.target.value})}/>
                                    
                                    <div className="space-y-3">
                                        <select required className="w-full p-3 border rounded-xl bg-white" value={bookingForm.service} onChange={e => {
                                            const sName = e.target.value;
                                            // Logic: Check if duration already picked, update price
                                            const newPrice = calculatePrice(sName, bookingForm.duration);
                                            setBookingForm({...bookingForm, service:sName, amount: newPrice});
                                        }}>
                                            <option value="">Select Service</option>
                                            {services.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>

                                        <select className="w-full p-3 border rounded-xl bg-white" value={bookingForm.duration} onChange={e => {
                                            const dName = e.target.value;
                                            const newPrice = calculatePrice(bookingForm.service, dName);
                                            setBookingForm({...bookingForm, duration:dName, amount: newPrice});
                                        }}>
                                            <option value="">Select Duration</option>
                                            {durations.map(d=><option key={d.id} value={d.name}>{d.name}</option>)}
                                        </select>

                                        <select required className="w-full p-3 border rounded-xl bg-white" value={bookingForm.therapist} onChange={e=>setBookingForm({...bookingForm, therapist:e.target.value})}>
                                            <option value="">Select Therapist</option>
                                            {therapists.map(t=><option key={t.id} value={t.name}>{t.name}</option>)}
                                        </select>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <input required type="number" placeholder="Price" className="w-full p-3 border rounded-xl" value={bookingForm.amount} onChange={e=>setBookingForm({...bookingForm, amount:e.target.value})}/>
                                        <input required type="time" className="w-full p-3 border rounded-xl" value={bookingForm.time} onChange={e=>setBookingForm({...bookingForm, time:e.target.value})}/>
                                    </div>

                                    <button className="w-full bg-logo-green-700 text-white font-bold py-4 rounded-xl shadow hover:bg-logo-green-800 transition">Confirm Booking</button>
                                </form>
                            </div>
                        )}

                        {view === 'lists' && user.role === 'admin' && <ListManagement therapists={therapists} services={services} durations={durations} onAdd={handleListAdd} onDelete={handleListDelete} onEdit={handleListEdit}/>}

                        {view === 'history' && user.role === 'admin' && (
                            <div className="space-y-4 fade-in">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-bold text-lg">History Archive</h2>
                                    <button onClick={()=>loadHistory(50)} className="text-xs bg-slate-200 px-3 py-1 rounded-full hover:bg-slate-300"><Icons.RotateCw size={12}/> Refresh</button>
                                </div>
                                {loading ? <div className="text-center py-10"><div className="loader mx-auto"></div></div> : 
                                 history.length === 0 ? <p className="text-center text-slate-400 py-10">No history found.</p> :
                                 history.map(h => (
                                    <div key={h.id} className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <div onClick={()=>setHistoryExpanded(historyExpanded===h.id?null:h.id)} className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50">
                                            <div><h4 className="font-bold">{h.date}</h4><p className="text-xs text-slate-400">{h.branch} • {h.closedBy}</p></div>
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-logo-green-700">{formatCurrency(h.stats?.totalRevenue)}</span>
                                                <button onClick={(e)=>{e.stopPropagation(); downloadCSV(h)}}><Icons.Download size={16} className="text-slate-400 hover:text-logo-green-600"/></button>
                                            </div>
                                        </div>
                                        {historyExpanded===h.id && <div className="bg-slate-50 p-4 text-sm border-t border-slate-100">
                                            {h.transactions.map((t,i)=>(
                                                <div key={i} className="flex justify-between py-1 border-b border-slate-200/50 last:border-0">
                                                    <span className="text-slate-600">{t.time} - {t.clientName} ({t.service})</span>
                                                    <span className="font-medium">{formatCurrency(t.amount)}</span>
                                                </div>
                                            ))}
                                        </div>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Modals */}
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 fade-in"><div className="bg-white rounded-xl p-6 max-w-xs w-full text-center"><p className={`font-bold mb-4 text-${modal.confirmColor}-600`}>{modal.message}</p><button onClick={()=>setModal({isOpen:false})} className="bg-slate-100 px-6 py-2 rounded-full font-bold text-slate-600">Close</button></div></div>}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
